<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Plant Lookup</title>

    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Tempus Dominus CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@@eonasdan/
    .0`         tempus-dominus@6.7.19/dist/css/tempus-dominus.min.css"
        rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/PlantsInformationWeb.styles.css" asp-append-version="true" />
</head>

<body>
    <!-- Navigation Header -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top"
            style="border-bottom: 1px solid rgba(76, 175, 80, 0.1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
            <div class="container-lg">
                <!-- Brand -->
                <a class="navbar-brand d-flex align-items-center fw-bold" asp-page="/Index"
                    style="font-size: 1.3rem; color: #2d5016;">
                    <i class="bi bi-flower1 me-2" style="font-size: 1.8rem; color: #4CAF50;"></i>
                    <span>Plant Lookup</span>
                </a>

                <!-- Mobile Toggle -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Navigation Menu -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto ms-4">
                        <li class="nav-item">
                            <a class="nav-link fw-500" asp-page="/Index" style="color: #2d5016;">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-500" asp-page="/Plants" style="color: #2d5016;">Plants</a>
                        </li>
                        @if (User.Identity.IsAuthenticated && User.IsInRole("admin"))
                        {
                            <li class="nav-item">
                                <a class="nav-link fw-500" asp-page="/Admin/Dashboard" style="color: #2d5016;">Dashboard</a>
                            </li>
                        }
                        <li class="nav-item">
                            <a class="nav-link fw-500" asp-page="/About" style="color: #2d5016;">About Us</a>
                        </li>
                    </ul>

                    <!-- Search Bar -->
                    <form method="get" asp-page="/Plants" class="d-flex me-3 mb-2 mb-lg-0">
                        <div class="input-group" style="max-width: 280px;">
                            <input type="text" class="form-control search-input" name="keyword"
                                placeholder="Search plants..." id="heroSearch"
                                style="border: 1px solid #e0e0e0; border-radius: 8px 0 0 8px; font-size: 0.95rem; padding-left: 10px">
                            <button class="btn search-btn" type="submit"
                                style="background-color: #4CAF50; color: white; border-radius: 0 8px 8px 0; border: 1px solid #4CAF50;">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- User Account & Notifications -->
                    @if (User.Identity != null && User.Identity.IsAuthenticated)
                    {
                        <div class="d-flex align-items-center gap-2 position-relative">
                            <!-- Notification Button -->
                            <div class="notification-container position-relative">
                                <button id="notificationButton" class="btn btn-sm notification-btn"
                                    style="background-color: #f0f7f0; color: #2d5016; border: 1px solid #c8e6c9; border-radius: 8px; position: relative; padding: 0.5rem 0.75rem;">
                                    <i class="bi bi-bell" style="font-size: 1.1rem;"></i>
                                    <span id="notificationBadge" class="notification-badge"
                                        style="position: absolute; top: -5px; right: -5px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; display: none;">0</span>
                                </button>

                                <!-- Notification Dropdown -->
                                <div id="notificationDropdown" class="notification-dropdown shadow-sm"
                                    style="display: none; position: absolute; top: 100%; right: 0; min-width: 320px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: white; z-index: 1050; margin-top: 0.5rem;">
                                    <div style="padding: 1rem; border-bottom: 1px solid #e0e0e0;">
                                        <h6 class="mb-0 fw-bold" style="color: #2d5016;">Notifications</h6>
                                    </div>
                                    <div id="notificationList" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Notifications will be loaded here via AJAX -->
                                        <div style="padding: 1rem; text-align: center; color: #999;">
                                            <i class="bi bi-inbox"
                                                style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                                            <p style="margin: 0; font-size: 0.9rem;">No notifications yet</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Profile Button -->
                            <button id="userButton" class="btn btn-sm fw-500"
                                style="background-color: #f0f7f0; color: #2d5016; border: 1px solid #c8e6c9; border-radius: 8px;">
                                <i class="bi bi-person-circle me-1"></i>
                                @User.Identity.Name
                                <i class="bi bi-caret-down-fill ms-1"></i>
                            </button>

                            <div id="userDropdown" class="dropdown-menu shadow-sm"
                                style="display: none; min-width: 180px; border: 1px solid #e0e0e0; border-radius: 8px; top: 100%; right: 0;">
                                <a class="dropdown-item" asp-page="/Plants" asp-route-favorite="true">
                                    <i class="bi bi-heart me-2" style="color: #4CAF50;"></i>Favorite Plants
                                </a>
                                <div class="dropdown-divider"></div>
                                <form method="get" asp-page="/Account/Logout">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                                    </button>
                                </form>
                            </div>
                        </div>
                    }
                    else
                    {
                        <a class="btn btn-sm fw-500" asp-page="/Account/Login"
                            style="background-color: #4CAF50; color: white; border-radius: 8px;">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Login
                        </a>
                    }
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main role="main" class="main-container">
        <div>
            @RenderBody()
        </div>
    </main>

    <!-- Footer -->
    @if (ViewBag.HideFooter == null || ViewBag.HideFooter == false)
    {
        <footer class="footer-section mt-5"
            style="background: linear-gradient(135deg, #f8fdf6 0%, #f0f7f0 100%); border-top: 1px solid rgba(76, 175, 80, 0.15);">
            <div class="container-lg py-5">
                <div class="row g-4 mb-4">
                    <!-- Brand Section -->
                    <div class="col-lg-4 col-md-6">
                        <div class="mb-3">
                            <h5 class="fw-bold mb-3" style="color: #2d5016;">
                                <i class="bi bi-flower1 me-2" style="color: #4CAF50;"></i>Plant Lookup
                            </h5>
                            <p style="color: #555; font-size: 0.95rem; line-height: 1.6;">Your comprehensive resource for
                                plant information, care guides, and botanical knowledge.</p>
                        </div>
                        <div class="social-links">
                            <a href="#" class="me-3" style="color: #4CAF50; text-decoration: none; font-size: 1.2rem;"><i
                                    class="bi bi-facebook"></i></a>
                            <a href="#" class="me-3" style="color: #4CAF50; text-decoration: none; font-size: 1.2rem;"><i
                                    class="bi bi-twitter"></i></a>
                            <a href="#" class="me-3" style="color: #4CAF50; text-decoration: none; font-size: 1.2rem;"><i
                                    class="bi bi-instagram"></i></a>
                            <a href="#" style="color: #4CAF50; text-decoration: none; font-size: 1.2rem;"><i
                                    class="bi bi-youtube"></i></a>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="col-lg-2 col-md-6">
                        <h6 class="fw-bold mb-3" style="color: #2d5016;">Quick Links</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><a asp-page="/Index" style="color: #555; text-decoration: none;">Home</a></li>
                            <li class="mb-2"><a asp-page="/Plants" style="color: #555; text-decoration: none;">Plants</a>
                            </li>
                            <li class="mb-2"><a asp-page="/CareGuides" style="color: #555; text-decoration: none;">Care
                                    Guides</a></li>
                            <li><a asp-page="/References" style="color: #555; text-decoration: none;">References</a></li>
                        </ul>
                    </div>

                    <!-- Categories -->
                    <div class="col-lg-3 col-md-6">
                        <h6 class="fw-bold mb-3" style="color: #2d5016;">Categories</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><a asp-page="/Plants" asp-route-category="flowers"
                                    style="color: #555; text-decoration: none;">Flowers</a></li>
                            <li class="mb-2"><a asp-page="/Plants" asp-route-category="trees"
                                    style="color: #555; text-decoration: none;">Trees</a></li>
                            <li class="mb-2"><a asp-page="/Plants" asp-route-category="herbs"
                                    style="color: #555; text-decoration: none;">Herbs</a></li>
                            <li><a asp-page="/Plants" asp-route-category="vegetables"
                                    style="color: #555; text-decoration: none;">Vegetables</a></li>
                        </ul>
                    </div>

                    <!-- Contact Info -->
                    <div class="col-lg-3 col-md-6">
                        <h6 class="fw-bold mb-3" style="color: #2d5016;">Contact Info</h6>
                        <p class="mb-2" style="color: #555; font-size: 0.95rem;">
                            <i class="bi bi-envelope me-2" style="color: #4CAF50;"></i>
                            info@plantlookup.com
                        </p>
                        <p class="mb-2" style="color: #555; font-size: 0.95rem;">
                            <i class="bi bi-phone me-2" style="color: #4CAF50;"></i>
                            +1 (555) 123-4567
                        </p>
                        <p style="color: #555; font-size: 0.95rem;">
                            <i class="bi bi-geo-alt me-2" style="color: #4CAF50;"></i>
                            FPT Software, Đà Nẵng
                        </p>
                    </div>
                </div>

                <!-- Footer Bottom -->
                <hr style="border-color: rgba(76, 175, 80, 0.2);">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-0" style="color: #666; font-size: 0.9rem;">&copy; 2025 Plant Lookup. All rights
                            reserved.</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="#"
                            style="color: #4CAF50; text-decoration: none; margin-right: 1.5rem; font-size: 0.9rem;">Privacy
                            Policy</a>
                        <a href="#" style="color: #4CAF50; text-decoration: none; font-size: 0.9rem;">Terms of Service</a>
                    </div>
                </div>
            </div>
        </footer>
    }

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="@Html.Raw("https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js")"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        // Notification Button Toggle
        document.getElementById('notificationButton')?.addEventListener('click', function (e) {
            e.stopPropagation();
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        // User Dropdown Toggle
        document.getElementById('userButton')?.addEventListener('click', function (e) {
            e.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            const notificationButton = document.getElementById('notificationButton');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const userButton = document.getElementById('userButton');
            const userDropdown = document.getElementById('userDropdown');

            if (notificationButton && notificationDropdown && !notificationButton.contains(event.target) && !notificationDropdown.contains(event.target)) {
                notificationDropdown.style.display = 'none';
            }

            if (userButton && userDropdown && !userButton.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.style.display = 'none';
            }
        });

        function loadNotifications() {
            fetch('/api/notifications')
                .then(response => response.json())
                .then(data => {
                    updateNotificationUI(data);
                })
                .catch(err => {
                    document.getElementById('notificationBadge').style.display = 'none';
                });
        }
        $(document).off('click', '.notification-item').on('click', '.notification-item', function () {
            const notificationId = $(this).data('notification-id');
            const commentId = $(this).data('comment-id');
            const plantId = $(this).data('plant-id');

            markNotificationAsRead(notificationId);

            // Lấy plantId hiện tại của trang
            const currentPlantId = new URLSearchParams(window.location.search).get("id");

            if (String(currentPlantId) === String(plantId)) {
                // Cùng trang, scroll tới comment
                scrollToComment(commentId);
            } else {
                // Khác trang, chuyển tới trang đó với hash comment
                window.location.href = `/PlantDetail?id=${plantId}#comment-${commentId}`;
            }
        });

        function markNotificationAsRead(notificationId) {
            $.ajax({
                url: '/api/notifications/read',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(notificationId),
                success: function () {
                    loadNotifications();
                }
            });
        }
        function scrollToComment(commentId) {
            const $target = $('#comment-' + commentId);
            if ($target.length) {
                $('html, body').animate({ scrollTop: $target.offset().top - 100 }, 600);
                $target.addClass('highlight');
                setTimeout(() => $target.removeClass('highlight'), 2000);
            }
        }

        function updateNotificationUI(notifications) {
            const notificationList = document.getElementById('notificationList');
            const badge = document.getElementById('notificationBadge');

            const unreadNoti = notifications.filter(n => !n.isRead).length;
            console.log("Số thông báo chưa đọc:", unreadNoti);

            if (notifications.length === 0) {
                notificationList.innerHTML = `
            <div style="padding: 1rem; text-align: center; color: #999;">
                <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                <p style="margin: 0; font-size: 0.9rem;">No notifications yet</p>
            </div>
        `;
                badge.style.display = 'none';
            } else {
                let html = '';
                notifications.forEach(notification => {
                    html += `
                        <div 
                            class="notification-item${!notification.isRead ? ' unread' : ''}"
                            style="
                            padding: 1rem; 
                            border-bottom: 1px solid #f0f0f0;
                            cursor: pointer; 
                            transition: background-color 0.2s;
                            background-color: ${!notification.isRead ? '#eafbe7' : '#fff'};
                            border-left: 4px solid ${!notification.isRead ? '#4CAF50' : 'transparent'};
                            font-weight: ${!notification.isRead ? '500' : '400'};
                            "
                            data-notification-id="${notification.notificationId}" 
                            data-comment-id="${notification.commentId}"
                            data-plant-id="${notification.plantId}"
                            onmouseover="this.style.backgroundColor='#f9f9f9'" 
                            onmouseout="this.style.backgroundColor='${!notification.isRead ? '#eafbe7' : '#fff'}'"
                        >
                            <div style="display: flex; gap: 0.75rem;">
                            <div style="flex-shrink: 0;">
                                <i class="bi bi-info-circle" style="font-size: 1.25rem; color: #4CAF50;"></i>
                            </div>
                            <div style="flex-grow: 1;">
                                <p style="
                                margin: 0; 
                                font-weight: 500; 
                                font-size: 0.9rem; 
                                color: ${!notification.isRead ? '#2d5016' : '#888'};
                                ">${notification.title}</p>
                                <p style="
                                margin: 0.25rem 0 0 0; 
                                font-size: 0.85rem; 
                                color: ${!notification.isRead ? '#2d5016' : '#666'};
                                ">${notification.message}</p>
                                <small style="
                                color: ${!notification.isRead ? '#2d5016' : '#999'};
                                font-size: 0.8rem;
                                font-weight: ${!notification.isRead ? '500' : '400'};
                                ">${notification.timestamp}</small>
                            </div>
                            </div>
                        </div>
                        `;
                });
                notificationList.innerHTML = html;

                if (unreadNoti > 0) {
                    badge.textContent = unreadNoti;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Load notifications on page load
        loadNotifications();

        // SignalR Connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .build();

        connection.on("AccountLocked", function (reason) {
            alert("Account Locked: " + reason);
            window.location.href = "/Account/Logout";
        });

        connection.on("NewNotification", function (notification) {
            loadNotifications();
        });

        connection.start().catch(function (err) {
            return console.error(err.toString());
        });
    </script>

    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>

</html>